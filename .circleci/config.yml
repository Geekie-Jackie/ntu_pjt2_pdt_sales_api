version: 2.1

orbs:
  # Define orbs for Docker and Synk
  docker: circleci/docker@2.4.0
  snyk: snyk/snyk@2.0.1
  maven: circleci/maven@1.4.1

executors:
  default-executor:
    docker:
      - image: cimg/openjdk:21.0.0

jobs:
  build:
    executor: default-executor
    steps:
      - checkout  # Check out your code
      - run:
          name: Build Spring Boot App
          # Compile and package your Spring Boot app with Maven
          command: |
            ./mvnw clean package -DskipTests
            mv target/pdt_sales-0.0.1-SNAPSHOT.jar app.jar
            
      - run:
          name: Build and Start PostgreSQL Container
          command: |
            # Start a PostgreSQL container using Docker Compose
            docker-compose -f /path/to/your/docker-compose.yml up -d

  test:
    executor: default-executor
    steps:
      - checkout
      - attach_workspace:
          at: /app
      - run:
          name: Run Product Service Tests
          command: |
            cd /root/NTU_PDT_SALES_API/pdt_sales  
            mvn test -Dtest=com.pdt_sales.pdt_sales.ServiceImplTest.ProductServiceImplTest
      - run:
          name: Run Sales Service Tests
          command: |
            cd /root/NTU_PDT_SALES_API/pdt_sales
            mvn test -Dtest=com.pdt_sales.pdt_sales.ServiceImplTest.SalesServiceImptTest

  # synk_scan:
  #   executor: default-executor
  #   steps:
  #     - checkout
  #     - snyk/scan:
  #         name: Synk Security Scan
  #         organization: your-organization
  #         project: your-project-name

workflows:
  version: 2
  ci_flow:
    jobs:
      - build
      - test:
          requires:
            - build
      # - synk_scan:
      #     requires:
      #       - build
